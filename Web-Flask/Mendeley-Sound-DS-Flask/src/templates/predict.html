{% extends "layout.html" %}
{% block content %}

<style>
  /* ‚îÄ‚îÄ Page layout ‚îÄ‚îÄ */
  .predict-page {
    display: flex;
    flex-direction: column;
    gap: 28px;
    max-width: 680px;
  }

  /* ‚îÄ‚îÄ Section cards ‚îÄ‚îÄ */
  .predict-section {
    background: rgba(0, 30, 55, 0.55);
    border: 1px solid rgba(0, 200, 255, 0.15);
    border-radius: 14px;
    padding: 26px 28px;
    backdrop-filter: blur(8px);
  }

  .predict-section h4 {
    margin: 0 0 18px 0;
    font-size: 16px;
    color: #00e5ff;
    letter-spacing: .5px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .predict-section h4 .badge-tag {
    font-size: 11px;
    background: rgba(0, 200, 255, 0.18);
    color: #00e5ff;
    border-radius: 20px;
    padding: 2px 10px;
    font-weight: 600;
    letter-spacing: 1px;
  }

  /* ‚îÄ‚îÄ File drop zone ‚îÄ‚îÄ */
  .drop-zone {
    border: 2px dashed rgba(0, 200, 255, 0.35);
    border-radius: 12px;
    padding: 32px 20px;
    text-align: center;
    cursor: pointer;
    transition: border-color .25s, background .25s;
    position: relative;
    background: rgba(0, 200, 255, 0.04);
  }

  .drop-zone:hover,
  .drop-zone.dragover {
    border-color: #00e5ff;
    background: rgba(0, 200, 255, 0.09);
  }

  .drop-zone input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  .drop-zone .dz-icon {
    font-size: 36px;
    margin-bottom: 8px;
    display: block;
  }

  .drop-zone .dz-label {
    color: #a0d8ef;
    font-size: 14px;
  }

  .drop-zone .dz-sub {
    color: rgba(160, 216, 239, 0.55);
    font-size: 12px;
    margin-top: 4px;
  }

  #chosen-file-name {
    margin-top: 10px;
    font-size: 13px;
    color: #00e5ff;
    min-height: 18px;
  }

  /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
  .btn-predict {
    margin-top: 16px;
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #00b4d8, #0077b6);
    color: #fff;
    border: none;
    border-radius: 8px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    letter-spacing: .5px;
    transition: opacity .2s, transform .1s;
  }

  .btn-predict:hover {
    opacity: .88;
    transform: translateY(-1px);
  }

  .btn-predict:active {
    transform: translateY(0);
  }

  /* ‚îÄ‚îÄ Manual form ‚îÄ‚îÄ */
  .manual-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }

  .manual-grid label {
    font-size: 13px;
    color: #a0d8ef;
    display: block;
    margin-bottom: 4px;
  }

  .manual-grid input {
    width: 100%;
    padding: 9px 10px;
    border-radius: 7px;
    border: 1px solid rgba(0, 200, 255, 0.2);
    background: rgba(0, 40, 70, 0.5);
    color: #eaffff;
    font-size: 14px;
    box-sizing: border-box;
    transition: border-color .2s;
  }

  .manual-grid input:focus {
    outline: none;
    border-color: #00e5ff;
  }

  /* ‚îÄ‚îÄ Result boxes ‚îÄ‚îÄ */
  .result-area {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .result-card {
    border-radius: 10px;
    padding: 16px 18px;
    display: flex;
    align-items: center;
    gap: 14px;
    border: 1px solid rgba(0, 200, 255, 0.18);
    background: rgba(0, 25, 50, 0.5);
  }

  .result-card .model-label {
    font-size: 13px;
    color: #a0d8ef;
    min-width: 120px;
  }

  .result-card .verdict {
    font-size: 20px;
    font-weight: 800;
    letter-spacing: 1px;
  }

  .verdict.adhd {
    color: #ff6b6b;
  }

  .verdict.control {
    color: #51cf66;
  }

  /* ‚îÄ‚îÄ Features table ‚îÄ‚îÄ */
  .feat-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-bottom: 16px;
  }

  .feat-table th {
    text-align: left;
    color: #a0d8ef;
    padding: 6px 10px;
    border-bottom: 1px solid rgba(0, 200, 255, 0.15);
  }

  .feat-table td {
    padding: 6px 10px;
    color: #d0f0ff;
    border-bottom: 1px solid rgba(0, 200, 255, 0.07);
    font-family: monospace;
  }

  /* ‚îÄ‚îÄ Error / info boxes ‚îÄ‚îÄ */
  .msg-error {
    padding: 12px 16px;
    background: rgba(255, 60, 60, 0.18);
    border: 1px solid rgba(255, 100, 100, 0.3);
    border-radius: 8px;
    color: #ffc9c9;
    font-size: 14px;
  }

  .msg-info {
    padding: 10px 14px;
    background: rgba(0, 200, 255, 0.08);
    border: 1px solid rgba(0, 200, 255, 0.2);
    border-radius: 8px;
    color: #a0d8ef;
    font-size: 12px;
    margin-bottom: 14px;
  }

  /* ‚îÄ‚îÄ Divider ‚îÄ‚îÄ */
  .section-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    color: rgba(160, 216, 239, 0.4);
    font-size: 12px;
  }

  .section-divider::before,
  .section-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: rgba(0, 200, 255, 0.15);
  }
</style>

<div class="predict-page">

  <h3 style="margin:0 0 4px 0; color:#eaffff;">üß† ADHD Prediction</h3>
  <p style="margin:0 0 8px 0; color:#a0d8ef; font-size:13px;">
    Upload <strong>any .mat EEG dataset</strong> for automatic ADHD / Control prediction, or enter bandpower values
    manually.
  </p>
  <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:4px;">
    <span
      style="font-size:11px;background:rgba(0,200,255,0.12);color:#00e5ff;border-radius:20px;padding:3px 10px;">MATLAB
      v4‚Äìv7.3</span>
    <span style="font-size:11px;background:rgba(0,200,255,0.12);color:#00e5ff;border-radius:20px;padding:3px 10px;">HDF5
      / v7.3</span>
    <span style="font-size:11px;background:rgba(0,200,255,0.12);color:#00e5ff;border-radius:20px;padding:3px 10px;">Cell
      Arrays</span>
    <span style="font-size:11px;background:rgba(0,200,255,0.12);color:#00e5ff;border-radius:20px;padding:3px 10px;">1D /
      2D / 3D Arrays</span>
    <span style="font-size:11px;background:rgba(0,200,255,0.12);color:#00e5ff;border-radius:20px;padding:3px 10px;">Any
      Variable Name</span>
    <span
      style="font-size:11px;background:rgba(0,200,255,0.12);color:#00e5ff;border-radius:20px;padding:3px 10px;">Multi-subject</span>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SECTION 1 ‚Äî .mat File Upload
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="predict-section">
    <h4>
      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#00e5ff" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="17 8 12 3 7 8" />
        <line x1="12" y1="3" x2="12" y2="15" />
      </svg>
      Upload .mat File
      <span class="badge-tag">RECOMMENDED</span>
    </h4>

    <form method="POST" action="{{ url_for('predict_mat') }}" enctype="multipart/form-data">
      <div class="drop-zone" id="dropZone">
        <input type="file" name="mat_file" id="matFileInput" accept=".mat" onchange="showFileName(this)">
        <span class="dz-icon">üìÇ</span>
        <div class="dz-label">Click to browse or drag &amp; drop <strong>any EEG .mat file</strong> here</div>
        <div class="dz-sub">Works with any MATLAB dataset ‚Äî cell arrays, plain matrices, any shape, any variable name
        </div>
        <div class="dz-sub" style="margin-top:4px;">Supported: MATLAB v4 ¬∑ v5 ¬∑ v6 ¬∑ v7 ¬∑ v7.3 (HDF5) ¬∑ 1D ¬∑ 2D ¬∑ 3D
          arrays</div>
        <div id="chosen-file-name"></div>
      </div>

      <button type="submit" class="btn-predict">
        ‚ö° Predict from .mat File
      </button>
    </form>

    <!-- Error from mat upload -->
    {% if mat_error %}
    <div class="msg-error" style="margin-top:16px;">‚ö†Ô∏è {{ mat_error }}</div>
    {% endif %}

    <!-- Results from mat upload -->
    {% if mat_filename %}
    <div style="margin-top:20px;">
      <div class="msg-info">
        üìÑ <strong>{{ mat_filename }}</strong> &nbsp;|&nbsp; {{ mat_info }}
      </div>

      {% if mat_features %}
      <table class="feat-table">
        <thead>
          <tr>
            <th>Band</th>
            <th>Bandpower (¬µV¬≤/Hz)</th>
          </tr>
        </thead>
        <tbody>
          {% for band, val in mat_features.items() %}
          <tr>
            <td>{{ band }}</td>
            <td>{{ val }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}

      <div class="result-area">
        {% if mat_svm_result %}
        <div class="result-card">
          <div class="model-label">ü§ñ SVM Model</div>
          <div class="verdict {{ 'adhd' if mat_svm_result == 'ADHD' else 'control' }}">
            {{ mat_svm_result }}
          </div>
        </div>
        {% endif %}
        {% if mat_dl_result %}
        <div class="result-card">
          <div class="model-label">üß¨ GCN Model</div>
          <div class="verdict {{ 'adhd' if mat_dl_result == 'ADHD' else 'control' }}">
            {{ mat_dl_result }}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Divider -->
  <div class="section-divider">OR upload a CSV file</div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SECTION 2 ‚Äî CSV File Upload
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="predict-section">
    <h4>
      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#00e5ff" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
        <polyline points="14 2 14 8 20 8" />
        <line x1="16" y1="13" x2="8" y2="13" />
        <line x1="16" y1="17" x2="8" y2="17" />
        <polyline points="10 9 9 9 8 9" />
      </svg>
      Upload CSV File
    </h4>

    <!-- Format hint -->
    <div style="margin-bottom:14px; padding:10px 14px; background:rgba(0,200,255,0.06);
                border-radius:8px; border:1px solid rgba(0,200,255,0.15); font-size:12px; color:#a0d8ef;">
      <strong style="color:#00e5ff;">Supported CSV formats:</strong><br>
      <span style="opacity:.85;">
        &bull; <strong>Bandpower CSV</strong> ‚Äî columns named Delta, Theta, Alpha, Beta, Gamma (one subject per row)<br>
        &bull; <strong>Time-series CSV</strong> ‚Äî all-numeric columns (rows = time-points, columns = EEG channels)
      </span>
    </div>

    <form method="POST" action="{{ url_for('predict_csv') }}" enctype="multipart/form-data">
      <div class="drop-zone" id="csvDropZone">
        <input type="file" name="csv_file" id="csvFileInput" accept=".csv" onchange="showCsvFileName(this)">
        <span class="dz-icon">üìä</span>
        <div class="dz-label">Click to browse or drag &amp; drop <strong>any EEG CSV file</strong> here</div>
        <div class="dz-sub">Bandpower columns (Delta/Theta/Alpha/Beta/Gamma) or raw time-series</div>
        <div id="chosen-csv-name"></div>
      </div>
      <button type="submit" class="btn-predict" style="background:linear-gradient(135deg,#00b09b,#096c58);">
        üìä Predict from CSV File
      </button>
    </form>

    <!-- Error -->
    {% if csv_error %}
    <div class="msg-error" style="margin-top:16px;">‚ö†Ô∏è {{ csv_error }}</div>
    {% endif %}

    <!-- Results -->
    {% if csv_filename %}
    <div style="margin-top:20px;">
      <div class="msg-info">
        üìÑ <strong>{{ csv_filename }}</strong> &nbsp;|&nbsp;
        Type: <strong>{{ csv_type }}</strong> &nbsp;|&nbsp;
        Rows: <strong>{{ csv_n_rows }}</strong><br>
        <span style="opacity:.75; font-size:11px;">{{ csv_col_info }}</span>
      </div>

      <!-- Summary cards -->
      <div class="result-area" style="margin-bottom:16px;">
        <div class="result-card">
          <div class="model-label">ü§ñ SVM Overall</div>
          <div class="verdict {{ 'adhd' if csv_svm_summary == 'ADHD' else 'control' }}">
            {{ csv_svm_summary }}
          </div>
          <div style="margin-left:auto; font-size:12px; color:#a0d8ef;">
            ADHD: {{ csv_svm_adhd_pct }}% of rows
          </div>
        </div>
        <div class="result-card">
          <div class="model-label">üß¨ GCN Overall</div>
          <div class="verdict {{ 'adhd' if csv_gcn_summary == 'ADHD' else 'control' }}">
            {{ csv_gcn_summary }}
          </div>
          <div style="margin-left:auto; font-size:12px; color:#a0d8ef;">
            ADHD: {{ csv_gcn_adhd_pct }}% of rows
          </div>
        </div>
      </div>

      <!-- Per-row table -->
      {% if csv_rows and csv_rows|length > 1 %}
      <div style="overflow-x:auto;">
        <table class="feat-table" style="width:100%; min-width:600px;">
          <thead>
            <tr>
              <th>ID / Row</th>
              <th>Delta%</th>
              <th>Theta%</th>
              <th>Alpha%</th>
              <th>Beta%</th>
              <th>Gamma%</th>
              <th>SVM</th>
              <th>GCN</th>
            </tr>
          </thead>
          <tbody>
            {% for r in csv_rows %}
            <tr>
              <td>{{ r.row_id }}</td>
              <td>{{ r.delta }}</td>
              <td>{{ r.theta }}</td>
              <td>{{ r.alpha }}</td>
              <td>{{ r.beta }}</td>
              <td>{{ r.gamma }}</td>
              <td class="verdict {{ 'adhd' if r.svm == 'ADHD' else 'control' }}" style="font-size:13px;">
                {{ r.svm }}
              </td>
              <td class="verdict {{ 'adhd' if r.gcn == 'ADHD' else 'control' }}" style="font-size:13px;">
                {{ r.gcn }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- Divider -->
  <div class="section-divider">OR enter values manually</div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SECTION 3 ‚Äî Manual Entry
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="predict-section">
    <h4>
      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#00e5ff" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="2" />
        <path d="M3 9h18M9 21V9" />
      </svg>
      Manual Bandpower Entry
    </h4>

    <form method="POST" action="{{ url_for('predict') }}">
      <div class="manual-grid">
        <div>
          <label>Delta (1‚Äì4 Hz)</label>
          <input type="number" name="delta" step="0.000001" min="0" placeholder="e.g. 0.0012" required>
        </div>
        <div>
          <label>Theta (4‚Äì8 Hz)</label>
          <input type="number" name="theta" step="0.000001" min="0" placeholder="e.g. 0.0008" required>
        </div>
        <div>
          <label>Alpha (8‚Äì13 Hz)</label>
          <input type="number" name="alpha" step="0.000001" min="0" placeholder="e.g. 0.0005" required>
        </div>
        <div>
          <label>Beta (13‚Äì30 Hz)</label>
          <input type="number" name="beta" step="0.000001" min="0" placeholder="e.g. 0.0003" required>
        </div>
        <div style="grid-column: span 2;">
          <label>Gamma (30‚Äì45 Hz)</label>
          <input type="number" name="gamma" step="0.000001" min="0" placeholder="e.g. 0.0001" required>
        </div>
      </div>

      <button type="submit" class="btn-predict" style="background: linear-gradient(135deg,#7048e8,#4c6ef5);">
        üîç Predict from Values
      </button>
    </form>

    {% if error %}
    <div class="msg-error" style="margin-top:16px;">‚ö†Ô∏è {{ error }}</div>
    {% endif %}

    {% if result or ab_result %}
    <div class="result-area" style="margin-top:20px;">
      {% if result %}
      <div class="result-card">
        <div class="model-label">ü§ñ SVM Model</div>
        <div class="verdict {{ 'adhd' if result == 'ADHD' else 'control' }}">{{ result }}</div>
      </div>
      {% endif %}
      {% if ab_result %}
      <div class="result-card">
        <div class="model-label">üß¨ GCN Model</div>
        <div class="verdict {{ 'adhd' if ab_result == 'ADHD' else 'control' }}">{{ ab_result }}</div>
      </div>
      {% endif %}
    </div>
    {% endif %}
  </div>

</div>

<script>
  /* Show chosen filename ‚Äî .mat */
  function showFileName(input) {
    const label = document.getElementById('chosen-file-name');
    if (input.files && input.files.length > 0) {
      label.textContent = '‚úÖ ' + input.files[0].name;
    } else { label.textContent = ''; }
  }

  /* Show chosen filename ‚Äî .csv */
  function showCsvFileName(input) {
    const label = document.getElementById('chosen-csv-name');
    if (input.files && input.files.length > 0) {
      label.textContent = '‚úÖ ' + input.files[0].name;
    } else { label.textContent = ''; }
  }

  /* Drag-and-drop ‚Äî .mat */
  const dz = document.getElementById('dropZone');
  if (dz) {
    dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
    dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
    dz.addEventListener('drop', e => {
      e.preventDefault(); dz.classList.remove('dragover');
      const fi = document.getElementById('matFileInput');
      fi.files = e.dataTransfer.files; showFileName(fi);
    });
  }

  /* Drag-and-drop ‚Äî .csv */
  const cdz = document.getElementById('csvDropZone');
  if (cdz) {
    cdz.addEventListener('dragover', e => { e.preventDefault(); cdz.classList.add('dragover'); });
    cdz.addEventListener('dragleave', () => cdz.classList.remove('dragover'));
    cdz.addEventListener('drop', e => {
      e.preventDefault(); cdz.classList.remove('dragover');
      const fi = document.getElementById('csvFileInput');
      fi.files = e.dataTransfer.files; showCsvFileName(fi);
    });
  }
</script>

{% endblock %}